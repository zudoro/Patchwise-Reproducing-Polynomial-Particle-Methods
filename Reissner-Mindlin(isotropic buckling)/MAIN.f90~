PROGRAM MAIN

     USE NEWTYPE
     USE GLBVAR
     USE DOMAIN
     USE PLOT
	 	 USE PACKAGE
     USE ASSEMBLE
     USE BOUNDARY
     USE EIGEN
     USE LUDECOMPOSITION
     USE ERRORESTIMATE

     IMPLICIT NONE

	TYPE(SUBMAT) :: K
    REAL*8 :: M(INT(0.5*DOF*(DOF+1))), KG(INT(0.5*DOF*(DOF+1))), W, NCR
    REAL*8, ALLOCATABLE :: THIN_K(:,:), THIN_KG(:,:), THIN_M(:,:), Z(:,:)
    INTEGER :: INDX(3*DOF), I, J, REDUCEDOF, IERR
    LOGICAL :: BD_MASK(3*DOF)
    REAL :: CPTS, CPTE
    
	 CALL CPU_TIME(CPTS)
!    Get domain information and plot the domain
     CALL GETDOMAIN(OMEGA)
!    CALL PLOTDOMAIN()

!    Get background mesh and plot the mesh
     CALL GETBGMESH(OMEGA,BGMESH)
!     CALL PLOTBGMESH()

!	 Check pu and special (interpolation) functions
!	 CALL CHECKBASIS()

!    Assemble stiffness matrix and mass matrix
     CALL STIF(K)
		 CALL GEOSTIF(KG)
     CALL MASS(M)
	 
!    Find boundary nodes
	 CALL INFONODE(REDUCEDOF, BD_MASK)
	 
	 ALLOCATE(THIN_K(REDUCEDOF,REDUCEDOF), THIN_KG(REDUCEDOF, REDUCEDOF), THIN_M(REDUCEDOF,REDUCEDOF), &
						Z(REDUCEDOF,REDUCEDOF))
	 
!	 Reduce matrices [K] and [M]
	 CALL REDUCEMATRIX(THIN_K, THIN_KG, THIN_M, K, KG, M, REDUCEDOF, BD_MASK)

 	 OPEN(1, FILE='thin_k.dat')
 		DO I=1, REDUCEDOF
 			WRITE(1,*) (THIN_K(I,J), J=1,REDUCEDOF)
 		ENDDO
 	 CLOSE(1)
! 	 
 	 OPEN(1, FILE='thin_kg.dat')
 		DO I=1, REDUCEDOF
 			WRITE(1,*) (THIN_KG(I,J), J=1,REDUCEDOF)
 		ENDDO
 	 CLOSE(1)
! 
! 	 OPEN(1, FILE='thin_m.dat')
! 		DO I=1, REDUCEDOF
! 			WRITE(1,*) (THIN_M(I,J), J=1,REDUCEDOF)
! 		ENDDO
! 	 CLOSE(1)

!	 Find the smallest eigenvale (Fundamental frequency)
	 CALL PWMTD(THIN_K, THIN_KG, W)
!	 CALL RSG ( REDUCEDOF, THIN_K, THIN_KG, W, 1, Z, IERR )
	 PRINT*, ""
!	 PRINT*, "FUNDAMENTAL FREQUENCY : ", W*L*DSQRT(RHO/ G(1))
!	 PRINT*, "THE CRITICAL BUCKLING LOAD"
	 PRINT*, L(2)**2/(PI**2*STRESS_D(2,2))
!	 PRINT*, 'L**2/(PI**2*STRESS_D(2,2)) = ', L**2/(PI**2*STRESS_D(2,2))
! ! 	 NCR = 4.D0*STRESS_D(2,2)*(PI/L)**2*(1.D0+(3.D0*(1-V(1)**2)*PI**2*(h/L)**2)/KS)&
! ! 				 /(1.D0+((72.D0*(1.D0+V(1))*(1.D0-V(1)**2)*PI**4*(h/L)**4)/KS**2)+((6.D0*(1+V(1))*(3.D0-V(1))*PI**2*(h/L)**2)/KS))
! ! 	 NCR = NCR*L**2/(PI**2*STRESS_D(2,2))
! 	 PRINT*, 'ANALYTIC BUCKLING LOAD FOR ISOTROPIC : ', NCR
	 PRINT*, 'APPROXIMATED CRITICAL BUCKLING LOAD : ', W*L2**2/(PI**2*STRESS_D(2,2))
	 PRINT*, ""

	 CALL CPU_TIME(CPTE)
	 PRINT*, ""
	 PRINT*, "ELAPSED CPU TIME : ", CPTE - CPTS
	 PRINT*, ""

	 OPEN(1, FILE = 'result.dat')
	 	WRITE(1,*) "-----------------------------------"
	 	WRITE(1,*) "PARAMETERS OF CONSIDERD MATERIAL : "
	 	IF (PROPERTY.EQ.'ISO') THEN
	 		WRITE(1,*) "THIS MATERIAL IS ISOTROPIC SQUARE PLATE."
	 	ELSEIF (PROPERTY.EQ.'ORT') THEN
	 		WRITE(1,*) "THIS MATERIAL IS ORTHOTROPIC SQUARE PLATE."
	 	ENDIF
		WRITE(1,*) "TYPE OF BOUNDARY CONDITION : ", BCTYPE
		WRITE(1,*) "WIDTH OF THE PLATE : ", L1
		WRITE(1,*) "LENGTH OF THE PLATE : ", L2
		WRITE(1,*) "THICKNESS OF THE PLATE : ", h
		WRITE(1,*) "DENSITY OF THE MATERIAL : ", RHO
		WRITE(1,*) "REACTION FORCE BY HOOK'S LAW : ", HOOKS_K
		WRITE(1,*) ""
		WRITE(1,*) "RATIO OF WIDTH / LENGTH : ", L1 / L2
		WRITE(1,*) "RATIO OF THICKNESS / LENGTH : ", h / L2
		WRITE(1,*) "YOUNG'S MODULUS E : ", E(1)
		WRITE(1,*) "SHEAR MODULUS(CONSTANT OF RIGIDITY) : ", G(1)
		WRITE(1,*) "POISSON RATIO : ", V(1)
		WRITE(1,*) "SHEAR CORRECTION FACTOR : ", KS
	 	WRITE(1,*) "-----------------------------------"
	 	WRITE(1,*) "PARAMETERS OF PUFEM : "
	 	WRITE(1,*) "PU ORDER : ", GORDER
	 	WRITE(1,*) "RPP ORDER : ", IORDER
	 	WRITE(1,*) "DELTA : ", DELTA
	 	WRITE(1,*) "NUMBER OF PATCHES : ", NUMPATCHES
	 	WRITE(1,*) "DEGREE OF FREEDOM : ", DOF
	 	WRITE(1,*) "NUMBER OF GAUSS POINTS ON EACH PATCH : ", NGAUSSPT
	 	WRITE(1,*) "-----------------------------------"
		WRITE(1,*) "THE CRITICAL BUCKLING LOAD"
		WRITE(1,*) W*L2**2/(PI**2*STRESS_D(1,1))
		WRITE(1,*) ""
		WRITE(1,*) "ELAPSED CPU TIME : ", CPTE - CPTS
	 CLOSE(1)
	 DEALLOCATE(THIN_K,THIN_KG, THIN_M, Z)
	 
END PROGRAM MAIN
